{% extends "core/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}

<div class="animate-fade-in-up">

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    
    <div class="stat-card bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 100ms;">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-muted-foreground text-sm font-medium">Total Students</p>
          <p class="text-3xl font-bold text-foreground">
            {{ student_count|default:"0" }}
          </p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-blue-100 dark:bg-blue-500/10 transition-all duration-300">
          <i data-lucide="graduation-cap" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
        </div>
      </div>
    </div>

    <div class="stat-card bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 200ms;">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-muted-foreground text-sm font-medium">Active Faculty</p>
          <p class="text-3xl font-bold text-foreground">
            {{ faculty_count|default:"0" }}
          </p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-green-100 dark:bg-green-500/10 transition-all duration-300">
          <i data-lucide="users" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
        </div>
      </div>
    </div>

    <div class="stat-card bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 300ms;">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-muted-foreground text-sm font-medium">Active Courses</p>
          <p class="text-3xl font-bold text-foreground">
            {{ course_count|default:"0" }}
          </p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-yellow-100 dark:bg-yellow-500/10 transition-all duration-300">
          <i data-lucide="book-open" class="w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
        </div>
      </div>
    </div>

    <div class="stat-card bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 400ms;">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-muted-foreground text-sm font-medium">Overall Attendance</p>
          <p class="text-3xl font-bold text-foreground">
            {{ attendance_rate|default:"0.0" }}%
          </p>
        </div>
        <div class="w-12 h-12 rounded-lg flex items-center justify-center bg-indigo-100 dark:bg-indigo-500/10 transition-all duration-300">
          <i data-lucide="trending-up" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
        </div>
      </div>
    </div>

  </div>

  <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="lg:col-span-1 flex flex-col gap-6" style="animation-delay: 500ms;">
      
      {% if user.role == 'admin' %}
      <div class="bg-card p-6 rounded-2xl shadow-lg border border-border">
        <h3 class="text-lg font-semibold text-foreground mb-4">Quick Actions</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
          <a href="{% url 'add_student' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="user-plus" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Add Student</span>
          </a>
          <a href="{% url 'add_faculty' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="user-round-plus" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Add Faculty</span>
          </a>
          <a href="{% url 'courses:add_course' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="book-plus" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Add Course</span>
          </a>
          <a href="{% url 'attendance' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="clipboard-check" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Mark Attendance</span>
          </a>
          <a href="{% url 'exams' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="calendar-plus" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Schedule Exam</span>
          </a>
          <a href="{% url 'library' %}" class="flex flex-col items-center justify-center p-4 bg-muted hover:bg-primary/10 rounded-lg transition-all text-muted-foreground hover:text-primary">
            <i data-lucide="book-up" class="w-8 h-8 mb-2"></i>
            <span class="text-xs font-medium text-center">Issue Book</span>
          </a>
        </div>
      </div>
      {% endif %}

      <div class="bg-card p-6 rounded-2xl shadow-lg border border-border">
        <h3 class="text-lg font-semibold text-foreground mb-4">Alerts & Info</h3>
        <div class="space-y-3">
          {% if pending_faculty_count > 0 or overdue_books_count > 0 %}
            {% if user.role == 'admin' and pending_faculty_count > 0 %}
            <a href="{% url 'admin:core_user_changelist' %}?role__exact=faculty&is_active__exact=0" class="flex items-center gap-3 p-3 bg-yellow-100 dark:bg-yellow-500/10 rounded-lg group">
              <i data-lucide="user-check" class="w-5 h-5 text-yellow-700 dark:text-yellow-400"></i>
              <div>
                <p class="text-sm font-medium text-yellow-800 dark:text-yellow-300">{{ pending_faculty_count }} Faculty Account{{ pending_faculty_count|pluralize }}</p>
                <p class="text-xs text-yellow-700 dark:text-yellow-500 group-hover:underline">Pending Approval</p>
              </div>
            </a>
            {% endif %}
            {% if overdue_books_count > 0 %}
            <a href="{% url 'library' %}?tab=issues" class="flex items-center gap-3 p-3 bg-red-100 dark:bg-red-500/10 rounded-lg group">
              <i data-lucide="book-x" class="w-5 h-5 text-red-700 dark:text-red-400"></i>
              <div>
                <p class="text-sm font-medium text-red-800 dark:text-red-300">{{ overdue_books_count }} Overdue Book{{ overdue_books_count|pluralize }}</p>
                <p class="text-xs text-red-700 dark:text-red-500 group-hover:underline">Check Library Issues</p>
              </div>
            </a>
            {% endif %}
          {% else %}
            <div class="flex items-center gap-3 p-3 bg-green-100 dark:bg-green-500/10 rounded-lg">
              <i data-lucide="check-check" class="w-5 h-5 text-green-700 dark:text-green-400"></i>
              <div>
                <p class="text-sm font-medium text-green-800 dark:text-green-300">All Caught Up!</p>
                <p class="text-xs text-green-700 dark:text-green-500">No pending alerts.</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="lg:col-span-2 bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 600ms;">
      <h3 class="text-lg font-semibold text-foreground">Attendance Trend (Last 7 Days)</h3>
      <div class="h-96 mt-4">
        <canvas id="attendanceChart" data-labels='{{ attendance_trend_labels|escapejs }}' data-values='{{ attendance_trend_data|escapejs }}'></canvas>
      </div>
    </div>

    {% if user.role != 'admin' %}
    <div class="lg:col-span-1 bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 700ms;">
      <h3 class="text-lg font-semibold text-foreground mb-4">Today's Schedule</h3>
      <div class="space-y-3 max-h-96 overflow-y-auto pr-2">
        {% for entry in todays_schedule %}
          <div class="flex gap-3 stagger-animation">
            <div class="flex flex-col items-center justify-center w-16 text-sm bg-muted rounded-lg p-2">
              <span class="font-bold text-primary">{{ entry.start_time|time:"H:i" }}</span>
              <span class="text-xs text-muted-foreground">{{ entry.end_time|time:"H:i" }}</span>
            </div>
            <div class="flex-1">
              <p class="font-medium text-foreground">{{ entry.course.name }}</p>
              <p class="text-xs text-muted-foreground">
                <i data-lucide="user" class="w-3 h-3 inline-block -mt-0.5"></i> 
                {{ entry.faculty.user.first_name|default:'' }} {{ entry.faculty.user.last_name|default:'' }}
              </p>
              <p class="text-xs text-muted-foreground">
                <i data-lucide="map-pin" class="w-3 h-3 inline-block -mt-0.5"></i>
                Room: {{ entry.room }}
              </p>
            </div>
          </div>
        {% empty %}
          <div class="flex flex-col items-center justify-center text-center p-8">
            <i data-lucide="calendar-check" class="w-12 h-12 text-muted-foreground mb-4"></i>
            <p class="font-medium text-foreground">No Classes Scheduled</p>
            <p class="text-sm text-muted-foreground">Enjoy your day!</p>
          </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}


    <div class="lg:col-span-3 bg-card p-6 rounded-2xl shadow-lg border border-border" style="animation-delay: 800ms;">
      <h3 class="text-lg font-semibold text-foreground">Student Enrollment by Department</h3>
      <div class="h-80 mt-4 max-w-2xl mx-auto">
        <canvas id="enrollmentChart" data-labels='{{ dept_enrollment_labels|escapejs }}' data-values='{{ dept_enrollment_data|escapejs }}'></canvas>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    Chart.register(...(Chart.registerables || []));

    // --- 1. Attendance Chart (Line) ---
    const attendanceCtx = document.getElementById("attendanceChart");
    if (attendanceCtx) {
      // Read JSON data from data-attributes (escaped server-side)
      let attendanceLabels = [];
      let attendanceData = [];
      try {
        if (attendanceCtx.dataset.labels) attendanceLabels = JSON.parse(attendanceCtx.dataset.labels);
        if (attendanceCtx.dataset.values) attendanceData = JSON.parse(attendanceCtx.dataset.values);
      } catch (e) {
        console.warn('Failed to parse attendance chart data', e);
      }

      new Chart(attendanceCtx.getContext("2d"), {
        type: "line",
        data: {
          labels: attendanceLabels,
          datasets: [{
            label: "Attendance %",
            data: attendanceData,
            borderColor: "hsl(210, 100%, 50%)",
            backgroundColor: "hsla(210, 100%, 50%, 0.1)",
            fill: true,
            tension: 0.4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return ' ' + context.dataset.label + ': ' + context.formattedValue + '%';
                }
              }
            }
          },
          scales: { 
            y: { 
              beginAtZero: true, 
              max: 100, 
              ticks: { 
                color: 'var(--muted-foreground)',
                callback: function(value) { return value + '%'; }
              },
              grid: {
                color: 'var(--border)'
              }
            },
            x: {
              ticks: {
                color: 'var(--muted-foreground)'
              },
              grid: {
                display: false
              }
            }
          },
        },
      });
    }

    // --- 2. Enrollment Chart (Doughnut) ---
    const enrollmentCtx = document.getElementById("enrollmentChart");
    if (enrollmentCtx) {
      let enrollmentLabels = [];
      let enrollmentData = [];
      try {
        if (enrollmentCtx.dataset.labels) enrollmentLabels = JSON.parse(enrollmentCtx.dataset.labels);
        if (enrollmentCtx.dataset.values) enrollmentData = JSON.parse(enrollmentCtx.dataset.values);
      } catch (e) {
        console.warn('Failed to parse enrollment chart data', e);
      }

      new Chart(enrollmentCtx.getContext("2d"), {
        type: "doughnut",
        data: {
          labels: enrollmentLabels,
          datasets: [{
            data: enrollmentData,
            backgroundColor: [
              "hsl(210, 100%, 50%)", // chart-1
              "hsl(186, 100%, 38%)", // chart-2
              "hsl(36, 100%, 50%)",  // chart-3
              "hsl(142, 76%, 36%)", // chart-4
              "hsl(350, 89%, 60%)", // chart-5
              "hsl(260, 100%, 55%)", // primary-dark
            ],
            borderColor: 'var(--card)',
            borderWidth: 4,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              position: "bottom",
              labels: {
                color: 'var(--muted-foreground)',
                padding: 20,
                font: {
                  size: 14
                }
              }
            } 
          },
        },
      });
    }
  });
</script>

{% endblock %}